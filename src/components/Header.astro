---
import { locales, getLocaleFromUrl, type Locale } from "../i18n/utils";
import { t } from "../i18n/translations";
import LanguageSwitcher from "./LanguageSwitcher.svelte";

const locale = getLocaleFromUrl(Astro.url) as Locale;
const localePath = (path: string) => `/${locale}${path}`;

const navItems = [
  { key: "nav.home", href: localePath("/") },
  { key: "nav.services", href: localePath("/#services") },
  { key: "nav.coverage", href: localePath("/#coverage") },
  { key: "nav.insurance", href: localePath("/insurance") },
];

const currentPath = Astro.url.pathname;
const isHome = currentPath === `/${locale}` || currentPath === `/${locale}/`;
---

<header
  id="main-header"
  class="fixed top-0 w-full z-50 transition-all duration-500 border-b border-transparent"
>
  <div
    class="absolute inset-0 bg-white/0 dark:bg-gray-900/0 backdrop-blur-0 transition-all duration-500 -z-10"
    id="header-bg"
  >
  </div>

  <div
    class="max-w-[1200px] mx-auto px-4 lg:px-8 h-20 flex items-center justify-between"
  >
    <!-- Logo Section -->
    <a
      href={localePath("/")}
      class="relative z-20 flex items-center gap-2 group"
      aria-label="Home"
    >
      <img
        src="/images/logo-tms.svg"
        alt="TMS Bike Towing"
        class="h-10 w-auto group-hover:scale-105 transition-transform duration-300 drop-shadow-sm"
      />
    </a>

    <!-- Desktop Nav -->
    <nav class="hidden md:flex flex-1 justify-center gap-8">
      {
        navItems.map((item) => {
          const isActive =
            currentPath === item.href ||
            (item.href !== localePath("/") &&
              currentPath.startsWith(item.href));
          return (
            <a
              href={item.href}
              class:list={[
                "relative text-[15px] font-medium tracking-tight transition-colors duration-300 py-2",
                isActive
                  ? "text-[#1170FF] font-semibold"
                  : "text-[#64748b] hover:text-[#1170FF]",
              ]}
            >
              {t(locale, item.key)}
              {isActive && (
                <span class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-primary block" />
              )}
            </a>
          );
        })
      }
    </nav>

    <!-- Actions -->
    <div class="flex items-center gap-3 sm:gap-4 relative z-20">
      <div class="hidden sm:block">
        <LanguageSwitcher
          client:load
          locale={locale}
          currentPath={currentPath}
        />
      </div>

      <!-- Mobile Call Button -->
      <a
        href="tel:+66968873125"
        class="sm:hidden flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white shadow-lg shadow-green-500/30 hover:scale-105 transition-transform"
        aria-label="Call Now"
      >
        <span class="material-symbols-outlined text-[20px]">call</span>
      </a>

      <!-- Desktop CTA -->
      <a
        href={localePath("/towing")}
        class="hidden sm:inline-flex btn-primary px-6 py-2.5 text-sm font-semibold shadow-lg shadow-primary/25"
      >
        {t(locale, "cta.requestTow")}
      </a>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-btn"
        class="md:hidden relative z-50 w-10 h-10 flex flex-col justify-center items-center gap-1.5 group"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <span
          class="w-6 h-0.5 bg-[#0f172a] rounded-full transition-all duration-300 origin-center group-[.active]:rotate-45 group-[.active]:translate-y-2"
        ></span>
        <span
          class="w-6 h-0.5 bg-[#0f172a] rounded-full transition-all duration-300 group-[.active]:opacity-0"
        ></span>
        <span
          class="w-6 h-0.5 bg-[#0f172a] rounded-full transition-all duration-300 origin-center group-[.active]:-rotate-45 group-[.active]:-translate-y-2"
        ></span>
      </button>
    </div>
  </div>

  <!-- Mobile Navigation Overlay -->
  <div
    id="mobile-nav"
    class="fixed inset-0 z-10 bg-white/80 backdrop-blur-xl opacity-0 pointer-events-none transition-opacity duration-300 flex flex-col pt-24 px-6"
  >
    <!-- Background Pattern -->
    <div
      class="absolute inset-0 overflow-hidden pointer-events-none opacity-[0.03]"
    >
      <div
        class="absolute -top-20 -right-20 w-96 h-96 bg-primary rounded-full blur-3xl"
      >
      </div>
      <div
        class="absolute bottom-0 left-0 w-80 h-80 bg-blue-400 rounded-full blur-3xl"
      >
      </div>
    </div>

    <nav class="flex flex-col gap-2 relative z-10">
      {
        navItems.map((item, i) => (
          <a
            href={item.href}
            class="mobile-nav-link block text-2xl font-bold text-[#0f172a] py-4 border-b border-gray-200 opacity-0 translate-y-4 transition-all duration-500"
            style={`transition-delay: ${i * 50}ms`}
          >
            {t(locale, item.key)}
          </a>
        ))
      }
    </nav>

    <div
      class="mt-8 flex flex-col gap-4 opacity-0 translate-y-4 transition-all duration-500 delay-300 mobile-nav-footer"
    >
      <div class="flex items-center justify-between p-4 rounded-2xl bg-gray-50">
        <span class="text-sm font-medium text-[#64748b]">Language</span>
        <LanguageSwitcher
          client:load
          locale={locale}
          currentPath={currentPath}
        />
      </div>

      <a
        href={localePath("/towing")}
        class="btn-primary w-full py-4 text-center text-lg font-bold shadow-xl shadow-primary/20"
      >
        {t(locale, "cta.requestTow")}
      </a>
    </div>
  </div>
</header>

<script>
  const header = document.getElementById("main-header");
  const headerBg = document.getElementById("header-bg");
  const menuBtn = document.getElementById("mobile-menu-btn");
  const mobileNav = document.getElementById("mobile-nav");
  const mobileLinks = document.querySelectorAll(".mobile-nav-link");
  const mobileFooter = document.querySelector(".mobile-nav-footer");

  // Scroll Handler
  function updateHeader() {
    if (window.scrollY > 20) {
      // Transform to Floating Pill
      header?.classList.remove(
        "top-0",
        "w-full",
        "border-b",
        "border-transparent",
      );
      header?.classList.add(
        "top-4",
        "left-4",
        "right-4",
        "card-3d-glass",
        "shadow-2xl",
      );

      // We rely on card-3d-glass for background, so hide the inner bg
      headerBg?.classList.add("opacity-0");
    } else {
      // Reset to Top Bar
      header?.classList.add(
        "top-0",
        "w-full",
        "border-b",
        "border-transparent",
      );
      header?.classList.remove(
        "top-4",
        "left-4",
        "right-4",
        "card-3d-glass",
        "shadow-2xl",
      );

      headerBg?.classList.remove("opacity-0");
    }
  }

  window.addEventListener("scroll", updateHeader, { passive: true });
  updateHeader(); // Init

  // Mobile Menu Toggle
  menuBtn?.addEventListener("click", () => {
    const isExpanded = menuBtn.getAttribute("aria-expanded") === "true";
    menuBtn.setAttribute("aria-expanded", String(!isExpanded));
    menuBtn.classList.toggle("active");

    if (!isExpanded) {
      // Open
      mobileNav?.classList.remove("opacity-0", "pointer-events-none");
      document.body.style.overflow = "hidden"; // Prevent scrolling

      // Animate links in
      setTimeout(() => {
        mobileLinks.forEach((link) => {
          link.classList.remove("opacity-0", "translate-y-4");
        });
        mobileFooter?.classList.remove("opacity-0", "translate-y-4");
      }, 100);
    } else {
      // Close
      mobileNav?.classList.add("opacity-0", "pointer-events-none");
      document.body.style.overflow = "";

      // Reset animations
      mobileLinks.forEach((link) => {
        link.classList.add("opacity-0", "translate-y-4");
      });
      mobileFooter?.classList.add("opacity-0", "translate-y-4");
    }
  });
</script>
